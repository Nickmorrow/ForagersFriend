@namespace ForagerSite.Components.Profile
@using DataAccess.Models
@using ForagerSite.Services
@using Microsoft.AspNetCore.Components.Forms

@inject UserService userService

<EditForm Model="UserVm.user" OnValidSubmit="SaveChanges">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div>
        <label for="name">Name:</label>
        <InputText id="name" @bind-Value="UserVm.user.UsrName" />
    </div>

    <div>
        <label for="bio">Bio:</label>
        <InputTextArea id="bio" @bind-Value="UserVm.user.UsrBio" />
        <ValidationMessage For="@(() => UserVm.user.UsrBio)" />
        @if (UserVm.user.UsrBio?.Length > 250)
        {
            <p style="color: red;">Bio cannot exceed 250 characters.</p>
        }
    </div>

    <div>
        <label for="country">Country:</label>
        <InputText id="country" @bind-Value="UserVm.user.UsrCountry" />
    </div>

    <div>
        <label for="state">State/Province:</label>
        <InputText id="state" @bind-Value="UserVm.user.UsrStateorProvince" />
    </div>

    <div>
        <label for="zipcode">Zip Code:</label>
        <InputNumber id="zipcode" @bind-Value="UserVm.user.UsrZipCode" />
        @if (!IsValidZipCode(UserVm.user.UsrZipCode))
        {
            <p style="color: red;">Please enter a valid zip code.</p>
        }
    </div>

    <div>
        <label for="email">Email:</label>
        <InputText id="email" @bind-Value="UserVm.user.UsrEmail" />
        <ValidationMessage For="@(() => UserVm.user.UsrEmail)" />

        @if (string.IsNullOrWhiteSpace(UserVm.user.UsrEmail))
        {
            <p style="color: red;">You must enter an Email address.</p>
        }
        @if (!IsValidEmail(UserVm.user.UsrEmail) &&
                !string.IsNullOrWhiteSpace(UserVm.user.UsrEmail))
        {
            <p style="color: red;">Please enter a valid email address (e.g., example@domain.com).</p>
        }
        @if (userEmailExists)
        {
            <p style="color: red;">This email is already taken. Please choose a different one.</p>
        }
    </div>

    <div>
        <button type="submit">Save</button>
        <button type="button" @onclick="CancelEdit">Cancel</button>
    </div>
</EditForm>

@code {
    [Parameter] public UserViewModel UserVm { get; set; } = new();
    [Parameter] public EventCallback OnSaved { get; set; }
    [Parameter] public EventCallback OnCancelled { get; set; }

    private User originalUser = new();
    private bool userEmailExists;

    protected override void OnInitialized()
    {
        // Snapshot original values so Cancel can roll back
        originalUser = new User
        {
            UsrName = UserVm.user.UsrName,
            UsrBio = UserVm.user.UsrBio,
            UsrCountry = UserVm.user.UsrCountry,
            UsrStateorProvince = UserVm.user.UsrStateorProvince,
            UsrZipCode = UserVm.user.UsrZipCode,
            UsrEmail = UserVm.user.UsrEmail
        };
    }

    private bool IsValidEmail(string email)
    {
        try
        {
            var mailAddress = new System.Net.Mail.MailAddress(email);
            return mailAddress.Address == email;
        }
        catch
        {
            return false;
        }
    }

    private bool IsValidZipCode(int? zipCode)
    {
        if (zipCode == null) return false;
        return zipCode >= 10000 && zipCode <= 99999;
    }

    private async Task SaveChanges()
    {
        userEmailExists = await userService.EmailExists(
            UserVm.user.UsrEmail,
            UserVm.user);

        if (string.IsNullOrWhiteSpace(UserVm.user.UsrEmail))
            return;

        if (!IsValidEmail(UserVm.user.UsrEmail))
            return;

        if (userEmailExists)
            return;

        await userService.UpdateUserAsync(UserVm.user);

        if (OnSaved.HasDelegate)
        {
            await OnSaved.InvokeAsync();
        }
    }

    private async Task CancelEdit()
    {
        // Restore from snapshot
        UserVm.user.UsrName = originalUser.UsrName;
        UserVm.user.UsrBio = originalUser.UsrBio;
        UserVm.user.UsrCountry = originalUser.UsrCountry;
        UserVm.user.UsrStateorProvince = originalUser.UsrStateorProvince;
        UserVm.user.UsrZipCode = originalUser.UsrZipCode;
        UserVm.user.UsrEmail = originalUser.UsrEmail;

        if (OnCancelled.HasDelegate)
        {
            await OnCancelled.InvokeAsync();
        }
    }
}
