@using DataAccess.Models
@using ForagerSite.DataContainer
@using ForagerSite.Services
@using ForagerSite.Services.Interfaces
@using Utilities
@namespace ForagerSite.Components.Profile
@inject IUserService userService
@inject IUserSessionService session
@inject IConfiguration config

@if (!_loaded)
{
    <p>Loading profile...</p>
}
else
{
    <div id="profile-pic-container">
        @if (!editProfilePic)
        {
            <div>
                <img src="@profileImageUrl" alt="Profile Picture" style="max-width: 400px;" />
            </div>
            @if (CanEdit)
            {
                <p style="cursor: pointer;">
                    <a @onclick="EditProfilePic">Edit profile picture</a>
                </p>
            }
        }
        else
        {
            <div>
                @if (!string.IsNullOrEmpty(previewUrl))
                {
                    <div>
                        <img src="@previewUrl" alt="Preview" style="max-width: 400px; margin-top: 10px;" />
                    </div>
                }

                <label for="profilePicture">Profile Picture:</label>
                <InputFile type="file"
                           id="profilePicture"
                           OnChange="@(async e => await HandleFileChange(e))" />

                @if (errors.Any())
                {
                    <ul>
                        @foreach (var error in errors)
                        {
                            <li><p style="color: red;">@error</p></li>
                        }
                    </ul>
                }

                <div>
                    <p style="cursor: pointer;"><a @onclick="SaveProfilePic">Save Changes</a></p>
                    <p style="cursor: pointer;"><a @onclick="DeleteProfilePic">Delete</a></p>
                    <p style="cursor: pointer;"><a @onclick="CancelProfilePic">Cancel</a></p>
                </div>
            </div>
        }
    </div>
}


@code {
    [Parameter] public Guid UserId { get; set; }
    [Parameter] public bool CanEdit { get; set; }   

    private UserDataContainer userVm = new();
    private bool editProfilePic;
    private string profileImageUrl;
    private string previewUrl;
    private IBrowserFile? uploadedFile;
    private readonly List<string> errors = new();
    private bool _loaded;

    private static readonly string PlaceholderImageUrl = "UserProfileImages/Shared/PlaceHolder.jpeg";

    // protected override async Task OnInitializedAsync()
    // {
    //     userVm = await userService.GetUserViewModelById(userStateService.SessionUser.UserId);
    //     profileImageUrl = await GetProfileImageUrl();
    // }

    // protected override async Task OnAfterRenderAsync(bool firstRender)
    // {
    //     if (!firstRender) return;

    //     userVm = await userService.GetUserViewModelById(UserId);
    //     profileImageUrl = await GetProfileImageUrl();

    //     _loaded = true;
    //     StateHasChanged();
    // }
    protected override async Task OnParametersSetAsync()
    {
        _loaded = false;
        StateHasChanged();

        userVm = await userService.GetUserViewModelById(UserId);
        profileImageUrl = await GetProfileImageUrl();

        _loaded = true;
        StateHasChanged();
    }

    private async Task<string> GetProfileImageUrl()
    {
        var profilePicUrl = await userService.GetUserProfilePic(userVm.user); 
        return !string.IsNullOrEmpty(profilePicUrl) ? profilePicUrl : PlaceholderImageUrl;
    }

    private void EditProfilePic()
    {
        previewUrl = profileImageUrl;
        editProfilePic = true;
    }

    private void CancelProfilePic()
    {
        editProfilePic = false;
        uploadedFile = null;
        previewUrl = null;
        errors.Clear();
    }

    private async Task HandleFileChange(InputFileChangeEventArgs e)
    {
        (previewUrl, uploadedFile) = await PhotoUploadHelper.GeneratePreviewAsync(e, errors);
    }

    private async Task SaveProfilePic()
    {
        if (errors.Any() || uploadedFile == null)
            return;

        var userName = session.SessionUser!.Username;

        
        var newUrl = await PhotoUploadHelper.UploadProfilePic(
            errors,
            userName,
            uploadedFile,
            config,
            userService,
            userVm);

        if (string.IsNullOrEmpty(newUrl))
            return;

        profileImageUrl = newUrl;

        if (errors.Contains("Error uploading file"))
            return;

        editProfilePic = false;
        uploadedFile = null;
        previewUrl = null;
        errors.Clear();

        profileImageUrl = await GetProfileImageUrl();
    }

    private async Task DeleteProfilePic()
    {
        var userName = session.SessionUser!.Username;

        PhotoUploadHelper.DeleteProfilePic(
            errors,
            userName,
            uploadedFile,
            config,
            userService,
            userVm);

        editProfilePic = false;
        uploadedFile = null;
        previewUrl = null;
        errors.Clear();

        profileImageUrl = await GetProfileImageUrl();
    }
}
