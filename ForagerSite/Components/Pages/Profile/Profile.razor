
@page "/Profile"
@page "/profile/{UserId:guid}"

@using DataAccess.Models
@using ForagerSite.Components.Profile
@using ForagerSite.DataContainer
@using ForagerSite.Services
@using ForagerSite.Services.Interfaces
@using Utilities
@rendermode InteractiveServer
@inject IUserService userService
@inject IUserSessionService session
@inject IUserFindService userFindService
@inject IMapService mapService
@inject NavigationManager navigationManager

@if (!Pf_loaded)
{
    <p>Loading profile...</p>
}
else
{
    <h3>Profile</h3>

    <div id="containers" style="display: flex; gap: 20px;">
        <div id="profile-container">

            <ProfilePictureEditor UserId="@userVm.user.UsrId" CanEdit="IsMyProfile" />

            @if (!edit)
            {
                <div id="profile-details-container">
                    <p><strong>User Name:</strong> @userVm.userSecurity.UssUsername</p>
                    <p><strong>Name:</strong> @userVm.user.UsrName</p>
                    <p><strong>Rank:</strong> @GetUserRank(userVm.user.UsrExpScore)</p>
                    <p><strong>Joined:</strong> @userVm.user.UsrJoinedDate.ToString("MMMM dd, yyyy")</p>
                    <p><strong>Bio:</strong> @userVm.user.UsrBio</p>
                    <p><strong>Country:</strong> @userVm.user.UsrCountry</p>
                    <p><strong>State/Province:</strong> @userVm.user.UsrStateorProvince</p>
                    @if (IsMyProfile)
                    {
                        <button @onclick="EditProfile">Edit</button>
                    }
                </div>
            }
            else
            {
                @if (edit && IsMyProfile)
                {
                    <div id="edit-profile-container">
                        <ProfileDetailsEditor UserVm="userVm"
                                              OnSaved="HandleProfileSaved"
                                              OnCancelled="HandleProfileCancelled" />
                    </div>
                }
            }
        </div>
        <ProfileFindsList ViewModels="mapService.CurrentViewModels"
                          IsLoading="isLoading"
                          hasLoaded="hasLoaded" />

        <div id="friends-container">
            <h3>Friends</h3>
            <table>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>
}

@code {
    [Parameter] public Guid? UserId { get; set; }

    private Guid viewingUserId;
    private bool IsMyProfile => viewingUserId == session.SessionUser.UserId;
    private UserDataContainer userVm { get; set; } = new();
    private UserFindsDataContainer ufdc { get; set; } = new();
    private bool Pf_loaded;
    private bool isLoading = false;
    private bool hasLoaded = false;

    private bool edit;

    private static string GetUserRank(int? expScore)
    {
        return expScore switch
        {
            var x when x < 50 => "Sapling",
            var x when x < 150 => "Squirrel",
            var x when x < 400 => "Raccoon",
            var x when x < 800 => "Fox",
            var x when x < 1500 => "Hawk",
            var x when x < 3000 => "Owl",
            var x when x < 6000 => "Ranger",
            var x when x < 10000 => "Druid",
            _ => "Forest Spirit"
        };
    }




    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        await session.Load();

        if (!session.IsAuthenticated || session.SessionUser is null)
        {
            navigationManager.NavigateTo("/Login");
            return;
        }

        viewingUserId = UserId ?? session.SessionUser.UserId;

        isLoading = true;
        StateHasChanged();

        try
        {
            userVm = await userService.GetUserViewModelById(viewingUserId);

            mapService.userNamesKvp = await userFindService.GetCommentUserNames();

            // Load the viewed user's finds
            mapService.CurrentViewModels = await userFindService.GetUserFindsDCs(viewingUserId);

            // If I'm viewing someone else, hide private finds (for now)
            if (!IsMyProfile && mapService.CurrentViewModels != null)
            {
                foreach (var vm in mapService.CurrentViewModels)
                {
                    vm.finds = vm.finds
                        .Where(f => f.accessibility != "Private")
                        .ToList();
                }
            }

            mapService.MyViewModels = VmUtilities.Copy(mapService.CurrentViewModels);
        }
        finally
        {
            edit = false;
            Pf_loaded = true;
            hasLoaded = true;
            isLoading = false;
            StateHasChanged();
        }
    }



    private void EditProfile()
    {
        edit = true;
    }

    private void HandleProfileSaved()
    {
        edit = false;
    }

    private void HandleProfileCancelled()
    {
        edit = false;
    }


}
