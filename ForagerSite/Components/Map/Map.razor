@* @page "/map" *@

@using Newtonsoft.Json
@using ForagerSite.Services
@using DataAccess.Models
@using Utilities
@using ForagerSite.Components.Find
@rendermode InteractiveServer
@inject IJSRuntime JSRuntime
@inject IConfiguration config
@inject UserStateService userStateService
@inject UserService userService
@inject UserFindService userFindService
@inject MapService mapService

<div>
    <h4>Search</h4>
    <MapSearch OnGetAllFinds="GetAllFinds"
               OnGetMyFinds="GetMyFinds"
               OnSearch="HandleSearch" />

    <div id="map-container" style="display: flex; height: 800px;">
        <div id="map" style="flex: 2; height: 100%;"></div>

        @* The entire grid is now its own component *@
        <MapFindsGrid ViewModels="mapService.CurrentViewModels"
                      IsLoading="isLoading"
                      hasLoaded="hasLoaded"
                       />

    </div>
</div>

<div id="find-popup-template" style="display: none;">
    <p><strong>Name:</strong> {findName}</p>
    <p><strong>Discovered by:</strong> {username}</p>
    <div id="photo-gallery">
        {Images}
    </div>
    <p><strong>Species Type:</strong> {speciesType}</p>
    <p><strong>Use Category:</strong> {useCategory}</p>
</div>

<div></div>

@code {
    private DotNetObjectReference<MapService> _mapServiceReference;
    #region Initialize map + load data
    private bool isLoading = false;
    private bool hasLoaded = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var user = userStateService.CurrentUser.user;
            if (user != null)
            {
                isLoading = true;
                StateHasChanged(); 

                try
                {
                    _mapServiceReference = DotNetObjectReference.Create(mapService);
                    mapService.userNamesKvp = await userFindService.GetCommentUserNames();
                    mapService.CurrentViewModels = await userFindService.GetUserFindsViewModels(user.UsrId);
                    mapService.MyViewModels = VmUtilities.Copy(mapService.CurrentViewModels);

                    var json = JsonConvert.SerializeObject(
                        mapService.CurrentViewModels,
                        new JsonSerializerSettings
                        {
                            ReferenceLoopHandling = ReferenceLoopHandling.Ignore,
                            Formatting = Formatting.Indented
                        });

                    await JSRuntime.InvokeVoidAsync("setDotNetObjectReference", _mapServiceReference);
                    await JSRuntime.InvokeVoidAsync(
                        "initializeMap",
                        json,
                        user.UsrId.ToString(),
                        mapService.mapFilter,
                        user.UserSecurity.UssUsername);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error fetching ViewModels: {ex.Message}");
                }
                finally
                {
                    isLoading = false;
                    hasLoaded = true;       // 👈 important
                    StateHasChanged();
                }
            }
        }
    }

    #endregion
    #region Search / filters (called by MapSearch)
    private async Task GetMyFinds()
    {
        var user = userStateService.CurrentUser.user;

        if (user != null)
        {
            mapService.mapFilter = "UserOnly";
            mapService.CurrentViewModels = VmUtilities.Copy(mapService.MyViewModels);

            var settings = new JsonSerializerSettings
            {
                ReferenceLoopHandling = ReferenceLoopHandling.Ignore,
                Formatting = Formatting.Indented
            };

            var json = JsonConvert.SerializeObject(mapService.CurrentViewModels, settings);
            await JSRuntime.InvokeVoidAsync("initializeMap", json, user.UsrId.ToString(), mapService.mapFilter, user.UserSecurity.UssUsername);
        }
    }

    private async Task GetAllFinds()
    {
        var user = userStateService.CurrentUser.user;
        mapService.mapFilter = "AllUsers";

        try
        {
            if (!mapService.AllViewModels.Any())
            {
                try
                {
                    mapService.AllViewModels = await userFindService.GetUserFindsViewModels();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error fetching ViewModels: {ex.Message}");
                }
            }

            var settings = new JsonSerializerSettings
            {
                ReferenceLoopHandling = ReferenceLoopHandling.Ignore,
                Formatting = Formatting.Indented
            };

            mapService.CurrentViewModels = VmUtilities.Copy(mapService.AllViewModels);
            FilterAccessibility(mapService.CurrentViewModels, user.UsrId);

            var json = JsonConvert.SerializeObject(mapService.CurrentViewModels, settings);
            await JSRuntime.InvokeVoidAsync("initializeMap", json, user.UsrId.ToString(), mapService.mapFilter, user.UserSecurity.UssUsername);
        }
        finally
        {

        }
    }

    private void FilterAccessibility(List<UserFindsViewModel> currentViewModels, Guid userId)
    {
        foreach (var vm in currentViewModels)
        {
            if (vm.userId != userId)
            {
                vm.finds = vm.finds
                    .Where(f => f.accessibility != "Private")
                    .ToList(); // TODO: friends-only in future
            }
        }
    }

    private async Task HandleSearch(MapSearch.MapSearchCriteria criteria)
    {
        var user = userStateService.CurrentUser.user;

        var settings = new JsonSerializerSettings
        {
            ReferenceLoopHandling = ReferenceLoopHandling.Ignore,
            Formatting = Formatting.Indented
        };

        // Start from baseline based on current map filter
        if (mapService.mapFilter == "UserOnly")
        {
            mapService.CurrentViewModels = VmUtilities.Copy(mapService.MyViewModels);
        }
        else if (mapService.mapFilter == "AllUsers")
        {
            mapService.CurrentViewModels = VmUtilities.Copy(mapService.AllViewModels);
        }

        // Filter by user name
        if (!string.IsNullOrEmpty(criteria.UserSearchTerm))
        {
            mapService.CurrentViewModels = mapService.CurrentViewModels
                .Where(vm => vm.userName.Contains(criteria.UserSearchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        // Filter by species / category / keyword
        if (!string.IsNullOrEmpty(criteria.SelectedSpeciesType)
            || !string.IsNullOrEmpty(criteria.SelectedUseCategory)
            || !string.IsNullOrEmpty(criteria.FindSearchTerm))
        {
            foreach (var vm in mapService.CurrentViewModels)
            {
                vm.finds = vm.finds
                    .Where(f =>
                        (string.IsNullOrEmpty(criteria.SelectedSpeciesType) ||
                            f.speciesType.Equals(criteria.SelectedSpeciesType, StringComparison.OrdinalIgnoreCase))
                        && (string.IsNullOrEmpty(criteria.SelectedUseCategory) ||
                            f.useCategory.Equals(criteria.SelectedUseCategory, StringComparison.OrdinalIgnoreCase))
                        && (string.IsNullOrEmpty(criteria.FindSearchTerm) ||
                            f.findName.Contains(criteria.FindSearchTerm, StringComparison.OrdinalIgnoreCase))
                    )
                    .ToList();
            }
        }

        var json = JsonConvert.SerializeObject(mapService.CurrentViewModels, settings);
        await JSRuntime.InvokeVoidAsync("initializeMap", json, user.UsrId.ToString(), mapService.mapFilter);
    }
    #endregion
    public void Dispose()
    {
        _mapServiceReference?.Dispose();
    }
}
