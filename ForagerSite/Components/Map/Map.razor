@page "/map"

@using DataAccess.Models
@using ForagerSite.Components.Find
@using ForagerSite.DataContainer
@using ForagerSite.Services
@using ForagerSite.Services.Interfaces
@using Microsoft.AspNetCore.WebUtilities
@using Newtonsoft.Json
@using Utilities
@rendermode InteractiveServer
@inject IJSRuntime JS
@inject IConfiguration config
@inject IUserSessionService session
@inject IUserService userService
@inject IUserFindService userFindService
@inject IMapService mapService
@inject NavigationManager Nav

<div>
    <h4>Search</h4>
    <MapSearch OnGetAllFinds="GetAllFinds"
               OnGetMyFinds="GetMyFinds"
               OnSearch="HandleSearch" />

    <div id="map-container" style="display: flex; height: 800px;">
        <div id="map" style="flex: 2; height: 100%;"></div>

        <MapFindsGrid ViewModels="mapService.CurrentViewModels"
                      IsLoading="isLoading"
                      hasLoaded="hasLoaded"
                       />

    </div>
</div>

@* Template for map.js popup *@
<div id="find-popup-template" style="display: none;">
    <p><strong>Name:</strong> {findName}</p>
    <p><strong>Discovered by:</strong> {username}</p>
    <div id="photo-gallery">
        {Images}
    </div>
    <p><strong>Species Type:</strong> {speciesType}</p>
    <p><strong>Use Category:</strong> {useCategory}</p>
</div>



@code {
    private DotNetObjectReference<IMapService> _mapServiceReference;
    #region Initialize map + load data
    private bool isLoading = false;
    private bool hasLoaded = false;
    private Guid? focusFindId;

    private void ReadFocusFromQuery()
    {
        var uri = Nav.ToAbsoluteUri(Nav.Uri);
        var query = QueryHelpers.ParseQuery(uri.Query);

        if (query.TryGetValue("focusFindId", out var val) &&
            Guid.TryParse(val.ToString(), out var id))
        {
            focusFindId = id;
        }
    }
    private async Task WaitForMapReady()
    {
        // ~2 seconds max, checks every 50ms
        for (int i = 0; i < 40; i++)
        {
            var ready = await JS.InvokeAsync<bool>("isForagerMapReady");
            if (ready) return;
            await Task.Delay(50);
        }
    }

    private bool TryGetLatLngForFind(Guid findId, List<UserFindsDataContainer> vms, out double lat, out double lng)
    {
        lat = 0;
        lng = 0;

        var find = vms
            .SelectMany(vm => vm.finds)
            .FirstOrDefault(f => f.findId == findId);

        if (find?.findLocation == null)
            return false;

        lat = find.findLocation.latitude;
        lng = find.findLocation.longitude;
        return true;
    }

    private async Task FocusFindIfRequested(UserDataContainer userVm)
    {
        if (!focusFindId.HasValue)
            return;

        // Try current dataset first
        if (TryGetLatLngForFind(focusFindId.Value, mapService.CurrentViewModels, out var lat, out var lng))
        {
            await JS.InvokeVoidAsync("focusFindAfterDelay", lat, lng, 10);
            focusFindId = null;
            return;
        }

        // Not found => switch to AllUsers, rebuild markers, then focus
        mapService.mapFilter = "AllUsers";

        if (!mapService.AllViewModels.Any())
            mapService.AllViewModels = await userFindService.GetUserFindsDCs();

        mapService.CurrentViewModels = VmUtilities.Copy(mapService.AllViewModels);
        FilterAccessibility(mapService.CurrentViewModels, userVm.user.UsrId);

        var json = JsonConvert.SerializeObject(
            mapService.CurrentViewModels,
            new JsonSerializerSettings
            {
                ReferenceLoopHandling = ReferenceLoopHandling.Ignore,
                Formatting = Formatting.Indented
            });

        await JS.InvokeVoidAsync(
            "initializeMap",
            json,
            userVm.user.UsrId.ToString(),
            mapService.mapFilter,
            userVm.user.UserSecurity.UssUsername);

        if (TryGetLatLngForFind(focusFindId.Value, mapService.CurrentViewModels, out lat, out lng))
        {
            await JS.InvokeVoidAsync("focusFindAfterDelay", lat, lng, 10);
        }

        focusFindId = null;
    }


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            ReadFocusFromQuery();

            var userVm = await userService.GetUserViewModelById(session.SessionUser.UserId);
            if (userVm != null)
            {
                isLoading = true;
                StateHasChanged(); 

                try
                {
                    _mapServiceReference = DotNetObjectReference.Create(mapService);
                    mapService.userNamesKvp = await userFindService.GetCommentUserNames();
                    mapService.CurrentViewModels = await userFindService.GetUserFindsDCs(userVm.user.UsrId);
                    mapService.MyViewModels = VmUtilities.Copy(mapService.CurrentViewModels);

                    var json = JsonConvert.SerializeObject(
                        mapService.CurrentViewModels,
                        new JsonSerializerSettings
                        {
                            ReferenceLoopHandling = ReferenceLoopHandling.Ignore,
                            Formatting = Formatting.Indented
                        });

                    await JS.InvokeVoidAsync("setDotNetObjectReference", _mapServiceReference);
                    await JS.InvokeVoidAsync(
                        "initializeMap",
                        json,
                        userVm.user.UsrId.ToString(),
                        mapService.mapFilter,
                        userVm.user.UserSecurity.UssUsername
                    );
                    

                    await FocusFindIfRequested(userVm);
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error fetching ViewModels: {ex.Message}");
                }
                finally
                {
                    isLoading = false;
                    hasLoaded = true;       // 👈 important
                    StateHasChanged();
                }
            }
        }
    }

    #endregion
    #region Search / filters (called by MapSearch)
    private async Task GetMyFinds()
    {
        var userVm = await userService.GetUserViewModelById(session.SessionUser.UserId);

        if (userVm != null)
        {
            mapService.mapFilter = "UserOnly";
            mapService.CurrentViewModels = VmUtilities.Copy(mapService.MyViewModels);

            var settings = new JsonSerializerSettings
            {
                ReferenceLoopHandling = ReferenceLoopHandling.Ignore,
                Formatting = Formatting.Indented
            };

            var json = JsonConvert.SerializeObject(mapService.CurrentViewModels, settings);
            await JS.InvokeVoidAsync("initializeMap", json, userVm.user.UsrId.ToString(), mapService.mapFilter, userVm.user.UserSecurity.UssUsername);
        }
    }

    private async Task GetAllFinds()
    {
        var userVm = await userService.GetUserViewModelById(session.SessionUser.UserId);
        mapService.mapFilter = "AllUsers";

        try
        {
            if (!mapService.AllViewModels.Any())
            {
                try
                {
                    mapService.AllViewModels = await userFindService.GetUserFindsDCs();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error fetching ViewModels: {ex.Message}");
                }
            }

            var settings = new JsonSerializerSettings
            {
                ReferenceLoopHandling = ReferenceLoopHandling.Ignore,
                Formatting = Formatting.Indented
            };

            mapService.CurrentViewModels = VmUtilities.Copy(mapService.AllViewModels);
            FilterAccessibility(mapService.CurrentViewModels, userVm.user.UsrId);

            var json = JsonConvert.SerializeObject(mapService.CurrentViewModels, settings);
            await JS.InvokeVoidAsync("initializeMap", json, userVm.user.UsrId.ToString(), mapService.mapFilter, userVm.user.UserSecurity.UssUsername);
        }
        finally
        {

        }
    }

    private void FilterAccessibility(List<UserFindsDataContainer> currentViewModels, Guid userId)
    {
        foreach (var vm in currentViewModels)
        {
            if (vm.userId != userId)
            {
                vm.finds = vm.finds
                    .Where(f => f.accessibility != "Private")
                    .ToList(); // TODO: friends-only in future
            }
        }
    }

    private async Task HandleSearch(MapSearch.MapSearchCriteria criteria)
    {
        var userVm = await userService.GetUserViewModelById(session.SessionUser.UserId);

        var settings = new JsonSerializerSettings
        {
            ReferenceLoopHandling = ReferenceLoopHandling.Ignore,
            Formatting = Formatting.Indented
        };

        // Start from baseline based on current map filter
        if (mapService.mapFilter == "UserOnly")
        {
            mapService.CurrentViewModels = VmUtilities.Copy(mapService.MyViewModels);
        }
        else if (mapService.mapFilter == "AllUsers")
        {
            mapService.CurrentViewModels = VmUtilities.Copy(mapService.AllViewModels);
        }

        // Filter by user name
        if (!string.IsNullOrEmpty(criteria.UserSearchTerm))
        {
            mapService.CurrentViewModels = mapService.CurrentViewModels
                .Where(vm => vm.userName.Contains(criteria.UserSearchTerm, StringComparison.OrdinalIgnoreCase))
                .ToList();
        }

        // Filter by species / category / keyword
        if (!string.IsNullOrEmpty(criteria.SelectedSpeciesType)
            || !string.IsNullOrEmpty(criteria.SelectedUseCategory)
            || !string.IsNullOrEmpty(criteria.FindSearchTerm))
        {
            foreach (var vm in mapService.CurrentViewModels)
            {
                vm.finds = vm.finds
                    .Where(f =>
                        (string.IsNullOrEmpty(criteria.SelectedSpeciesType) ||
                            f.speciesType.Equals(criteria.SelectedSpeciesType, StringComparison.OrdinalIgnoreCase))
                        && (string.IsNullOrEmpty(criteria.SelectedUseCategory) ||
                            f.useCategory.Equals(criteria.SelectedUseCategory, StringComparison.OrdinalIgnoreCase))
                        && (string.IsNullOrEmpty(criteria.FindSearchTerm) ||
                            f.findName.Contains(criteria.FindSearchTerm, StringComparison.OrdinalIgnoreCase))
                    )
                    .ToList();
            }
        }

        var json = JsonConvert.SerializeObject(mapService.CurrentViewModels, settings);
        await JS.InvokeVoidAsync("initializeMap", json, userVm.user.UsrId.ToString(), mapService.mapFilter);
    }
    #endregion
    public void Dispose()
    {
        _mapServiceReference?.Dispose();
    }
}
