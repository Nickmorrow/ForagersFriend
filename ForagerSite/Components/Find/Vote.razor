@using DataAccess.Models
@using ForagerSite.Components.Find
@using ForagerSite.DataContainer
@using ForagerSite.Services

@inject UserSessionService session
@inject IMapService mapService

<div style="display:flex; gap:20px; margin-top:10px; align-items:center;">
    <span class="vote-container">
        <i class="bi bi-hand-thumbs-up-fill vote-icon @GetFindUpClass(find, comment)"
           @onclick='() => HandleUpvote(vmUserId, findOrCommentId, voteType)'></i>
        <span class="vote-count">@GetFindUpCount(find, comment)</span>
    </span>

    <span class="vote-container">
        <i class="bi bi-hand-thumbs-down-fill vote-icon @GetFindDownClass(find, comment)"
           @onclick='() => HandleDownVote(vmUserId, findOrCommentId, voteType)'></i>
        <span class="vote-count">@GetFindDownCount(find, comment)</span>
    </span>
</div>

@code {
    [Parameter] public FindDto find { get; set; }
    [Parameter] public FindCommentDto comment { get; set; }
    [Parameter] public Guid vmUserId { get; set; }
    [Parameter] public Guid findOrCommentId { get; set; }
    [Parameter] public string voteType { get; set; }  // "find" or "comment"


    private async Task HandleUpvote(Guid vmId, Guid findOrCommentId, string voteType)
    {
        var userId = session.SessionUser.UserId;
        await mapService.Vote(vmId, findOrCommentId, 1, voteType);
    }
    private async Task HandleDownVote(Guid vmId, Guid findOrCommentId, string voteType)
    {
        var userId = session.SessionUser.UserId;
        await mapService.Vote(vmId, findOrCommentId, -1, voteType);
    }

    // ---- Find-level vote counts ----
    private int GetFindUpCount(FindDto find = null, FindCommentDto commentDto = null)
    {
        int voteCount = 0;

        if (commentDto != null)
        {
            voteCount = commentDto.commentVotes?.Count(v => v.voteValue == 1) ?? 0;
        }
        if (find != null)
        {
            voteCount = find.findVotes?.Count(v => v.voteValue == 1) ?? 0;
        }
        return voteCount;
    }

    private int GetFindDownCount(FindDto find = null, FindCommentDto commentDto = null)
    {
        int voteCount = 0;

        if (commentDto != null)
        {
            voteCount = commentDto.commentVotes?.Count(v => v.voteValue == -1) ?? 0;
        }
        if (find != null)
        {
            voteCount = find.findVotes?.Count(v => v.voteValue == -1) ?? 0;
        }
        return voteCount;
    }

    // ---- Current user's vote for this find ----
    private int GetCurrentUserVote(FindDto find = null, FindCommentDto commentDto = null)
    {
        var userId = session.SessionUser.UserId;
        
        var myVote = new UserVoteDto();

        if (commentDto != null)
        {
            myVote = commentDto.commentVotes?.FirstOrDefault(v => v.voteUserId == userId);
        }
        if (find != null)
        {
            myVote = find.findVotes?.FirstOrDefault(v => v.voteUserId == userId);
        }

        return myVote?.voteValue ?? 0;   // 1, -1, or 0 (no vote)
    }

    // ---- CSS classes for icon coloring ----
    private string GetFindUpClass(FindDto find = null, FindCommentDto commentDto = null)
    {
        string voteClass = string.Empty;

        if (commentDto != null)
        {
            voteClass = GetCurrentUserVote(commentDto: commentDto) == 1 ? "vote-up-active" : string.Empty;
        }
        if (find != null)
        {
            voteClass = GetCurrentUserVote(find) == 1 ? "vote-up-active" : string.Empty;
        }
        return voteClass;
    }

    private string GetFindDownClass(FindDto find = null, FindCommentDto commentDto = null)
    {
        string voteClass = string.Empty;

        if (commentDto != null)
        {
            voteClass = GetCurrentUserVote(commentDto: commentDto) == -1 ? "vote-down-active" : string.Empty;
        }
        if (find != null)
        {
            voteClass = GetCurrentUserVote(find) == -1 ? "vote-down-active" : string.Empty;
        }
        return voteClass;
    }
}
