@using Microsoft.AspNetCore.Components.Forms
@using System.ComponentModel.DataAnnotations
@using ForagerSite.Services
@using ForagerSite.Utilities
@using ForagerSite.Components.Utility
@inject UserStateService userStateService
@inject IConfiguration config

<div>
<EditForm Model="findModel" OnValidSubmit="HandleValidSubmit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div>
        <label for="findName">Name:</label>
        <InputText id="findName" @bind-Value="findModel.FindName" />
    </div>

    <div>
        <label for="speciesName">Species Name:</label>
        <InputText id="speciesName" @bind-Value="findModel.SpeciesName" />
    </div>

    <div>
        <label for="speciesType">Species Type:</label>
        <InputSelect id="speciesType" @bind-Value="findModel.SpeciesType">
            <option value="">Select Type</option>
            <option value="tree">Tree</option>
            <option value="mushroom">Mushroom</option>
            <option value="fruit">Fruit</option>
            <option value="herb">Herb</option>
        </InputSelect>
    </div>

    <div>
        <label for="useCategory">Use Category:</label>
        <InputSelect id="useCategory" @bind-Value="findModel.UseCategory">
            <option value="">Select Category</option>
            <option value="medicinal">Medicinal</option>
            <option value="gourmet">Gourmet</option>
            <option value="crafting">Crafting</option>
        </InputSelect>
    </div>

    <div>
        <label for="features">Distinguishing Features:</label>
        <InputText id="features" @bind-Value="findModel.Features" />
    </div>

    <div>
        <label for="lookAlikes">Dangerous Lookalikes:</label>
        <InputText id="lookAlikes" @bind-Value="findModel.LookAlikes" />
    </div>

    <div>
        <label for="harvestMethod">Harvest Method:</label>
        <InputText id="harvestMethod" @bind-Value="findModel.HarvestMethod" />
    </div>

    <div>
        <label for="tastesLike">Tastes Like:</label>
        <InputText id="tastesLike" @bind-Value="findModel.TastesLike" />
    </div>

    <div>
        <label for="description">Notes:</label>
        <InputTextArea id="description" @bind-Value="findModel.Description" />
    </div>

    <div>
        <label>Images:</label>
        <ImageUploader @ref="imageUploader" OnImagesUploaded="OnImagesUploaded" Errors="uploadErrors" />
        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
            @for (int i = 0; i < imagePreviews.Count; i++)
            {
                var currentIndex = i;
                <div @key="imagePreviews[i]" style="position: relative; display: inline-block;">
                    <img src="@imagePreviews[i]" style="max-width: 100px; max-height: 100px;" />
                    <button type="button"
                            @onclick="() => RemoveImage(currentIndex)"
                            style="position: absolute; top: -5px; right: -5px;">
                        ✕
                    </button>
                </div>
            }
        </div>

        @if (uploadErrors.Any())
        {
            <ul style="color: red;">
                @foreach (var err in uploadErrors)
                {
                    <li>@err</li>
                }
            </ul>
        }

    </div>
    <div>
        <label>Who can see this?</label>
            <InputSelect @bind-Value="findModel.AccessLevel">
            <option value="Public">Public</option>
            <option value="Private">Private</option>
            <option value="Friends Only">Friends Only</option>
        </InputSelect>
    </div>
    <button type="submit">Save</button>
    <button @onclick="OnClose">Cancel</button> 
    </EditForm>
</div>
@code {
    private FindTemp findModel = new();
    private List<string> uploadErrors = new();
    private List<string> imagePreviews = new();
    private List<IBrowserFile> selectedFiles = new();
    private ImageUploader imageUploader;

    [Parameter]
    public EventCallback<FindTemp> OnFindCreated { get; set; }

    [Parameter]
    public EventCallback OnCreated { get; set; }

    [Parameter]
    public EventCallback OnClose { get; set; }

    private Task OnImagesUploaded(ImageUploadResult result)
    {
        uploadErrors.Clear();

        imagePreviews = result.Previews ?? new List<string>();
        selectedFiles = result.Files ?? new List<IBrowserFile>();

        StateHasChanged();

        return Task.CompletedTask;
    }

    private void ClearUploadedImages()
    {
        imagePreviews.Clear();
        selectedFiles.Clear();
        uploadErrors.Clear();

        imageUploader?.ResetFileInput();
    }

    private void RemoveImage(int index)
    {
        if (index >= 0 && index < imagePreviews.Count)
        {
            imagePreviews.RemoveAt(index);

            if (index < selectedFiles.Count)
            {
                selectedFiles.RemoveAt(index);
            }

            if (imagePreviews.Count == 0)
            {
                imageUploader?.ResetInput();
            }

            StateHasChanged();
        }
    }

    private async Task HandleValidSubmit()
    {
        uploadErrors.Clear(); 

        var userId = userStateService.SessionUser.UserId;
        var userName = userStateService.SessionUser.Username;
        findModel.UserId = userId;

        var uploadedUrls = await PhotoUploadHelper.UploadFindImages(selectedFiles, userName, config, uploadErrors);

        if (uploadErrors.Any())
        {
            return;
        }

        findModel.ImageUrls = uploadedUrls;

        findModel.AccessLevel = string.IsNullOrEmpty(findModel.AccessLevel) ? "Public" : findModel.AccessLevel;

        await OnFindCreated.InvokeAsync(findModel);

        findModel = new();
        imagePreviews.Clear();
    }



    public class FindTemp
    {
        [Required] public string FindName { get; set; }
        public string SpeciesName { get; set; } = "";
        [Required] public string SpeciesType { get; set; } 
        [Required] public string UseCategory { get; set; }
        public string Features { get; set; } = "";
        public string LookAlikes { get; set; } = "";
        public string HarvestMethod { get; set; } = "";
        public string TastesLike { get; set; } = "";
        public string Description { get; set; } = "";
        public string AccessLevel { get; set; }
        public Guid UserId { get; set; }
        public List<string> ImageUrls { get; set; } = new();
    }
}
