@rendermode InteractiveServer
@inject UserSessionService session
@inject NavigationManager Navigation
@implements IDisposable

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="">WildFinds</a>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="flex-column">

        @if (session.IsAuthenticated)
        {
            <div class="nav-item px-3">
                <NavLink class="nav-link" href="/" Match="NavLinkMatch.All">
                    <span class="bi bi-house-door-fill-nav-menu" aria-hidden="true"></span> Home
                </NavLink>
            </div>

            <div class="nav-item px-3">
                <NavLink class="nav-link" href="Profile">
                    <span class="bi bi-person" aria-hidden="true"></span> Profile
                </NavLink>
            </div>

            <div class="nav-item px-3">
                <NavLink class="nav-link" href="Inbox">
                    <span class="bi bi-mailbox" aria-hidden="true"></span> Inbox
                </NavLink>
            </div>

            <div class="nav-item px-3">
                <a href=""
                   class="nav-link"
                   @onclick="ToggleNotifications"
                   @onclick:preventDefault="true">
                    <span class="bi bi-bell"></span>
                    Notifications

                    @if (UnreadCount > 0)
                    {
                        <span class="notification-badge">@UnreadCount</span>
                    }
                </a>

                @if (showNotifications)
                {
                    <div class="notification-dropdown">
                        @if (Notifications != null && Notifications.Any())
                        {
                            <ul class="notification-list">
                                @foreach (var note in Notifications)
                                {
                                    <li class="notification-item">
                                        <div class="notification-message">@note.Message</div>
                                        <div class="notification-meta">
                                            @note.CreatedAt.ToLocalTime().ToString("g")
                                        </div>
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <div class="notification-empty">
                                No notifications.
                            </div>
                        }
                    </div>
                }
            </div>

            <div class="nav-item px-3">
                <a href="#" class="nav-link" @onclick="HandleLogout">
                    <span class="bi bi-box-arrow-right"></span> Log Out
                </a>
            </div>
        }
@*         else
        {
            <div class="nav-item px-3">
                <NavLink class="nav-link" href="/Login">
                    <span class="bi bi-box-arrow-in-right"></span> Login
                </NavLink>
            </div>
        } *@

    </nav>
</div>

@code {
    private bool showNotifications = false;

    private class NotificationItem
    {
        public string Message { get; set; } = "";
        public DateTime CreatedAt { get; set; }
        public bool IsRead { get; set; }
    }

    private List<NotificationItem> Notifications = new()
    {
        new NotificationItem { Message = "Welcome to Forager!", CreatedAt = DateTime.UtcNow.AddMinutes(-30), IsRead = false },
        new NotificationItem { Message = "Your friend Bill commented on your find.", CreatedAt = DateTime.UtcNow.AddHours(-2), IsRead = false },
        new NotificationItem { Message = "Profile updated successfully.", CreatedAt = DateTime.UtcNow.AddDays(-1), IsRead = true }
    };

    private int UnreadCount => Notifications?.Count(n => !n.IsRead) ?? 0;

    protected override void OnInitialized()
    {
        session.OnChange += OnUserStateChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender) return;

        // JS interop safe here (ProtectedSessionStorage)
        await session.Load();
        StateHasChanged();
    }

    private void OnUserStateChanged() => InvokeAsync(StateHasChanged);

    public void Dispose()
    {
        session.OnChange -= OnUserStateChanged;
    }

    private void ToggleNotifications()
    {
        showNotifications = !showNotifications;

        // Optional: mark all as read when opened
        if (showNotifications && Notifications != null)
        {
            foreach (var n in Notifications)
            {
                n.IsRead = true;
            }
        }
    }

    private async Task HandleLogout()
    {
        await session.Logout();
        Navigation.NavigateTo("/Login");
    }
}
