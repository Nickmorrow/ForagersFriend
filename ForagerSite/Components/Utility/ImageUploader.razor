@using Microsoft.AspNetCore.Components.Forms
@using ForagerSite.Utilities

<InputFile OnChange="HandleFileChange"
           multiple
           accept=".png,.jpg,.jpeg"
           @key="fileInputKey" />

@if (Errors?.Any() == true)
{
    <ul style="color: red;">
        @foreach (var error in Errors)
        {
            <li>@error</li>
        }
    </ul>
}

@code {
    [Parameter]
    public EventCallback<ImageUploadResult> OnImagesUploaded { get; set; }

    [Parameter]
    public List<string> Errors { get; set; }

    private const long MaxFileSize = 1024 * 1024 * 10; // 10 MB
    private const int MaxAllowedFiles = 4;
    private readonly string[] allowedExtensions = [".jpg", ".jpeg", ".png"];

    private Guid fileInputKey = Guid.NewGuid();

    public void ResetInput() => ResetFileInput();

    public void ResetFileInput()
    {
        fileInputKey = Guid.NewGuid(); // re-renders the input element
        StateHasChanged();
    }

    private async Task HandleFileChange(InputFileChangeEventArgs e)
    {
        Errors?.Clear();

        if (e.FileCount > MaxAllowedFiles)
        {
            Errors?.Add($"You can upload a maximum of {MaxAllowedFiles} images.");
            return;
        }

        var previews = new List<string>();
        var files = new List<IBrowserFile>();

        foreach (var file in e.GetMultipleFiles(MaxAllowedFiles))
        {
            var ext = Path.GetExtension(file.Name).ToLowerInvariant();
            if (!allowedExtensions.Contains(ext))
            {
                Errors?.Add($"Unsupported file format: {ext}");
                continue;
            }

            if (file.Size > MaxFileSize)
            {
                Errors?.Add($"'{file.Name}' exceeds max file size of {MaxFileSize / (1024 * 1024)} MB.");
                continue;
            }

            files.Add(file);

            await using var stream = file.OpenReadStream(MaxFileSize);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var bytes = ms.ToArray();

            var base64 = $"data:{file.ContentType};base64,{Convert.ToBase64String(bytes)}";
            previews.Add(base64);
        }

        if (Errors == null || Errors.Count == 0)
        {
            var result = new ImageUploadResult
            {
                Previews = previews,
                Files = files
            };

            await OnImagesUploaded.InvokeAsync(result);
        }
    }
}
